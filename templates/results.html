<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThyraPredict - Thyroid Health Assessment Results</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/assessment.css') }}">
</head>

<body>
    <!-- Background Blurs -->
    <div class="blur-shape blur-top-right"></div>
    <div class="blur-shape blur-bottom-left"></div>

    <!-- Header -->
    <header>
        <div class="header-container">
            <a href="/" class="brand">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="ThyraPredict Logo" class="brand-icon">
                <span>ThyraPredict</span>
            </a>
            <a href="/" class="btn-return">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    style="margin-right: 6px;">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
                Return to Home
            </a>
        </div>
    </header>

    <main>
        <!-- Hero Title -->
        <div class="hero-section">
            <h1 class="main-title">Your Thyroid Health Assessment</h1>
            <p class="subtitle">Based on your clinical markers you provided, here are your personalized results</p>
        </div>

        <!-- Main Grid Area -->
        <div class="results-grid">
            <!-- Left Column: Prediction Card -->
            <div class="card prediction-card">
                <div class="card-header-center">
                    <h3 id="predictionLabel">PREDICTION</h3>
                </div>

                <!-- Circular Gauge -->
                <div class="gauge-container" id="gaugeContainer">
                    <div class="gauge-circle">
                        <span class="score-text" id="scoreText">--</span>
                        <span class="score-label" id="scoreLabel">LOADING</span>
                    </div>
                </div>

                <div class="prediction-result">
                    <h2 id="diagnosisTitle">LOADING...</h2>
                    <p id="diagnosisDescription">Loading your assessment results...</p>
                </div>

                <div class="toggle-section" id="toggleBreakdown">
                    <span id="toggleText">Show breakdown</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 15l-6-6-6 6" />
                    </svg>
                </div>

                <!-- Breakdown Stats -->
                <div class="stats-row" id="statsRow" style="display: none;">
                    <div class="stat-item" id="stat1">
                        <div class="stat-icon">üìÑ</div>
                        <span class="stat-label">Normal</span>
                        <span class="stat-value">--</span>
                        <span class="stat-sub">PREDICTED SCORE</span>
                    </div>
                    <div class="stat-item" id="stat2">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <span class="stat-label">Hyperthyroidism</span>
                        <span class="stat-value">--</span>
                        <span class="stat-sub">PREDICTED SCORE</span>
                    </div>
                    <div class="stat-item" id="stat3">
                        <div class="stat-icon">üìã</div>
                        <span class="stat-label">Hypothyroidism</span>
                        <span class="stat-value">--</span>
                        <span class="stat-sub">PREDICTED SCORE</span>
                    </div>
                </div>
            </div>

            <!-- Right Column: Info Card -->
            <div class="card info-card">
                <div class="img-placeholder-anatomy">
                    <img id="thyroidImage" src="https://images.unsplash.com/photo-1576091160550-112f9c8bad6e?w=400&h=200&fit=crop" alt="Thyroid Anatomy">
                </div>
                <div class="info-content">
                    <h3 id="thyroidInfoTitle">Normal Thyroid Gland</h3>
                    <p id="thyroidInfoDescription">The normal thyroid gland is a butterfly-shaped organ located in the base of your neck. It
                        produces hormones that regulate your body's metabolism.</p>
                </div>
            </div>
        </div>

        <!-- Warning Banner -->
        <div class="warning-banner">
            <p><strong>Important:</strong> This assessment is for informational purposes only and does not constitute
                medical advice. Always consult with qualified healthcare professionals for diagnosis and treatment of
                thyroid disorders.</p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="location.href='/predict'">Take Another Assessment</button>
            <a href="/resources" class="btn btn-primary">Helpful Resources</a>
        </div>

        <!-- Bottom Video Section -->
        <div class="card video-card">
            <div class="video-content-wrapper">
                <h3>Want to Learn More About Thyroid Conditions?</h3>
                <p>Visit our resources page to explore comprehensive information about hypothyroidism, hyperthyroidism, and how to manage your thyroid health.</p>

                <video class="video-player" controls>
                    <source src="{{ url_for('static', filename='videos/videomain.mp4') }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>

                <a href="/resources" class="btn btn-teal-solid">Explore Resources</a>
            </div>
        </div>

    </main>

    <script>
        // Get prediction results from session storage or window variable
        let predictionResults = window.predictionResults || {};
        
        // Try to get from session storage if not in window
        if (!predictionResults.prediction) {
            const resultsJSON = sessionStorage.getItem('predictionResults');
            if (resultsJSON) {
                const results = JSON.parse(resultsJSON);
                
                // Normalize the results format
                predictionResults = {
                    prediction: (results.prediction || results.prediction_class || 'negative').toLowerCase(),
                    confidence: parseFloat(results.confidence || results.confidence_score || 0.5),
                    probabilities: results.probabilities || {
                        'negative': parseFloat(results.negative_prob || 0.33),
                        'Hypo': parseFloat(results.hypothyroid_prob || results.hypo_prob || 0.33),
                        'Hyper': parseFloat(results.hyperthyroid_prob || results.hyper_prob || 0.33)
                    }
                };
                
                // Normalize prediction names
                const pred = predictionResults.prediction;
                if (pred.includes('hyper')) {
                    predictionResults.prediction = 'hyperthyroid';
                } else if (pred.includes('hypo')) {
                    predictionResults.prediction = 'hypothyroid';
                } else {
                    predictionResults.prediction = 'negative';
                }
                
                window.predictionResults = predictionResults;
            }
        }
        
        console.log('Loaded prediction results:', predictionResults);
    </script>
    <script src="{{ url_for('static', filename='js/results.js') }}"></script>
    <script>
        // Execute after results.js loads
        document.addEventListener('DOMContentLoaded', function() {
            const resultsData = window.predictionResults || {};
            
            console.log('Updating UI with results:', resultsData);
            
            if (Object.keys(resultsData).length === 0) {
                // If no data, show placeholder or redirect to prediction form
                document.getElementById('diagnosisTitle').textContent = 'No Results';
                document.getElementById('diagnosisDescription').textContent = 'Please complete an assessment first.';
                return;
            }
            
            // Extract prediction data
            const prediction = (resultsData.prediction || 'NEGATIVE').toLowerCase();
            let confidence = (resultsData.confidence || 0);
            
            // If confidence is already a percentage (> 1), don't multiply by 100
            if (confidence <= 1) {
                confidence = confidence * 100;
            }
            
            const probabilities = resultsData.probabilities || {};
            
            console.log('Prediction:', prediction);
            console.log('Confidence:', confidence);
            console.log('Probabilities:', probabilities);
            
            // Map prediction to display name and color
            const predictionMap = {
                'negative': { name: 'NEGATIVE', risk: 'LOW RISK', color: '#27ae60' },
                'hyperthyroid': { name: 'HYPERTHYROIDISM', risk: 'ELEVATED RISK', color: '#e74c3c' },
                'hypothyroid': { name: 'HYPOTHYROIDISM', risk: 'ELEVATED RISK', color: '#f39c12' }
            };
            
            const predInfo = predictionMap[prediction] || { name: prediction.toUpperCase(), risk: 'NEEDS REVIEW', color: '#95a5a6' };
            
            // Update prediction display
            document.getElementById('diagnosisTitle').textContent = predInfo.name;
            document.getElementById('scoreText').textContent = confidence.toFixed(1) + '%';
            document.getElementById('scoreLabel').textContent = predInfo.risk;
            
            // Update thyroid info based on prediction
            if (prediction === 'hyperthyroid') {
                document.getElementById('thyroidInfoTitle').textContent = 'Hyperthyroidism';
                document.getElementById('thyroidInfoDescription').textContent = 'Hyperthyroidism occurs when the thyroid gland produces too much thyroid hormone. This can cause symptoms like rapid heartbeat, anxiety, weight loss, and tremors. It requires medical attention and treatment.';
                // Set hyperactive thyroid image
                document.getElementById('thyroidImage').src = 'static/images/hyper.png';
                document.getElementById('thyroidImage').alt = 'Overactive Thyroid Gland - Hyperthyroidism';
            } else if (prediction === 'hypothyroid') {
                document.getElementById('thyroidInfoTitle').textContent = 'Hypothyroidism';
                document.getElementById('thyroidInfoDescription').textContent = 'Hypothyroidism occurs when the thyroid gland does not produce enough thyroid hormone. This can cause fatigue, weight gain, cold sensitivity, and depression. It is typically managed with medication.';
                // Set underactive thyroid image
                document.getElementById('thyroidImage').src = 'static/images/hypo.png';
                document.getElementById('thyroidImage').alt = 'Underactive Thyroid Gland - Hypothyroidism';
            } else {
                // Normal thyroid image for negative prediction
                document.getElementById('thyroidImage').src = 'static/images/normal.png';
                document.getElementById('thyroidImage').alt = 'Normal Thyroid Gland';
            }
            
            // Update prediction description
            const descriptions = {
                'negative': 'Your results indicate no significant thyroid condition detected. However, maintain regular check-ups to monitor your thyroid health.',
                'hyperthyroid': 'Your results suggest signs of hyperthyroidism. Schedule a consultation with an endocrinologist for proper diagnosis and treatment planning.',
                'hypothyroid': 'Your results suggest signs of hypothyroidism. Schedule a consultation with an endocrinologist for proper diagnosis and treatment planning.'
            };
            document.getElementById('diagnosisDescription').textContent = descriptions[prediction] || 'Please consult with a healthcare professional for personalized advice.';
            
            // Update breakdown stats
            if (probabilities && Object.keys(probabilities).length > 0) {
                // Helper function to convert value to percentage
                const toPercent = (val) => {
                    const num = parseFloat(val) || 0;
                    return num > 1 ? num : num * 100;
                };
                
                const negative = toPercent(probabilities['Negative'] || probabilities['negative'] || 0).toFixed(1);
                const hyper = toPercent(probabilities['Hyper'] || probabilities['hyperthyroid'] || probabilities['hyper'] || 0).toFixed(1);
                const hypo = toPercent(probabilities['Hypo'] || probabilities['hypothyroid'] || probabilities['hypo'] || 0).toFixed(1);
                
                document.querySelector('#stat1 .stat-value').textContent = negative + '%';
                document.querySelector('#stat2 .stat-value').textContent = hyper + '%';
                document.querySelector('#stat3 .stat-value').textContent = hypo + '%';
            }
            
            // Toggle breakdown visibility
            let showBreakdown = false;
            document.getElementById('toggleBreakdown').addEventListener('click', function() {
                showBreakdown = !showBreakdown;
                document.getElementById('statsRow').style.display = showBreakdown ? 'flex' : 'none';
                document.getElementById('toggleText').textContent = showBreakdown ? 'Hide breakdown' : 'Show breakdown';
            });
        });
    </script>
</body>

</html>
